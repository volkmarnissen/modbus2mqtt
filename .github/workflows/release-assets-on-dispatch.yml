name: "On dispatch: Release assets"

on:
  workflow_call:
    inputs:
      version:
        description: 'Version: patch|minor|major or explicit (e.g. 1.2.3). If omitted, read from package.json.'
        required: false
        type: string
      skip_github_release:
        description: 'Skip GitHub Release creation (used when Release Please already created it).'
        required: false
        type: boolean
        default: false
    outputs:
      resolved_version:
        description: 'Resolved version used for tagging.'
        value: ${{ jobs.build-and-release.outputs.resolved_version }}
      image_tag:
        description: 'Docker image tag (v<version>).'
        value: v${{ jobs.build-and-release.outputs.resolved_version }}
  workflow_dispatch:
    inputs:
      version:
        description: 'Version: patch|minor|major or explicit (e.g. 1.2.3). If omitted, read from package.json.'
        required: false
        type: string

permissions:
  contents: write
  packages: write

env:
  product_name: modbus2mqtt
  main_docker_name: 'ghcr.io/${{ github.repository_owner }}/modbus2mqtt'

jobs:
  build-and-release:
    name: "Build and push Docker image"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      resolved_version: ${{ steps.setver.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Resolve version
        id: setver
        run: |
          set -euo pipefail
          input_version="${{ inputs.version }}"
          if [ -z "$input_version" ]; then
            # No version given — read from package.json
            resolved="$(node -p "require('./package.json').version")"
          elif echo "$input_version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            # Explicit semver (e.g. from Release Please) — use directly
            resolved="$input_version"
          else
            # Bump keyword (patch|minor|major) — use npm version
            git config --global user.email "noreply@github.com"
            git config --global user.name "Workflow User"
            resolved="$(npm version "$input_version" | sed -e 's/^v//g')"
            git push --follow-tags
          fi
          echo "resolved_version=$resolved" >> $GITHUB_OUTPUT
          echo "Using version: $resolved"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node (from .nvmrc)
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          (cd frontend && pnpm install --frozen-lockfile)
          pnpm run build

      - name: Run backend unit tests
        run: cd backend && pnpm run test

      - name: Run integration tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: cd backend && pnpm run test:integration

      - name: Create npm pack tarball
        run: |
          npm pack --pack-destination docker/
          mv docker/modbus2mqtt-*.tgz docker/modbus2mqtt.tgz
          echo "Tarball size: $(du -h docker/modbus2mqtt.tgz | cut -f1)"

      - name: Read Node.js major version from .nvmrc
        id: nodeversion
        run: echo "major=$(cut -d. -f1 .nvmrc)" >> $GITHUB_OUTPUT

      - name: Setup QEMU (for arm64 emulation)
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        env:
          DOCKER_BUILD_SUMMARY: false
        with:
          context: .
          file: docker/Dockerfile.npm-pack
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.main_docker_name }}:${{ steps.setver.outputs.resolved_version }}
            ${{ env.main_docker_name }}:latest
          build-args: |
            NODE_MAJOR=${{ steps.nodeversion.outputs.major }}
            BUILD_VERSION=${{ steps.setver.outputs.resolved_version }}
            BUILD_REF=${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}
            BUILD_REPOSITORY=${{ github.repository }}

      - name: Create GitHub Release
        if: ${{ !inputs.skip_github_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.setver.outputs.resolved_version }}
          generate_release_notes: true
          body: |
            ## Docker Image

            ```bash
            docker pull ${{ env.main_docker_name }}:${{ steps.setver.outputs.resolved_version }}
            ```

            **Multi-architecture support:** `linux/amd64`, `linux/arm64`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update_hassio_addon_version:
    runs-on: ubuntu-latest
    needs: build-and-release
    environment: release
    steps:
      - name: Checkout modbus2mqtt Repository
        uses: actions/checkout@v5

      - name: Checkout hassio-addon-repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository_owner }}/hassio-addon-repository
          path: hassio-addon-repository
          ref: refs/heads/main
          token: ${{ secrets.PAT }}

      - name: Update Version in config.yaml
        run: |
          sed -i -e 's/version: .*/version: ${{ needs.build-and-release.outputs.resolved_version }}/g' \
          -e 's|image: .*|image: ${{ env.main_docker_name }}|g' \
          -e 's|\(url: https://github.com/\)[^/]*\/[^/]*\(.*\)|\1${{ github.repository }}\2|g' \
          hassio-addon-repository/${{ env.product_name }}/config.yaml

      - name: Generate changelog
        uses: heinrichreimer/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output: hassio-addon-repository/${{ env.product_name }}/CHANGELOG.md
          headerLabel: '## Changelog for Modbus <=> MQTT'

      - name: Checkin hassio-addon-repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ needs.build-and-release.outputs.resolved_version }}
          repository: hassio-addon-repository
