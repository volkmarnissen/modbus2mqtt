#!/bin/sh 
set -e
TMPDIR="$(mktemp -d -t modbus2mqttXXXXX)"
export TMPDIR
export MPID=$$
localhost="127.0.0.1"
trap 'echo signal 15 $MPID $TMPDIR; rm -rf $TMPDIR; kill -15 $MPID; exit 1' 15
trap 'echo signal 2 $MPID $TMPDIR; rm -rf $TMPDIR; kill -2 $MPID; exit 1;' 2

HTTPPORT=3004
if [ $# -ge 1 ]
then
    HTTPPORT=$1
fi
TMPFILES="cypress/servers/tmpfiles"
mkdir -p "$(dirname "$TMPFILES")"
DEBUGTMPDIR=e2e/modbus2mqtt.temp
if [ -r e2e/modbus2mqtt.temp ] && grep "httpport: $1" e2e/modbus2mqtt.temp/modbus2mqtt/modbus2mqtt.yaml >/dev/null 2>&1
then
    echo "Using existing debug tmpdir $DEBUGTMPDIR"
    TMPDIR=$DEBUGTMPDIR
  if [ -f "$TMPFILES" ]; then
    grep -v "^$HTTPPORT " "$TMPFILES" >"$TMPFILES.tmp" || true
    mv "$TMPFILES.tmp" "$TMPFILES"
  fi
  echo "$HTTPPORT $TMPDIR" >>"$TMPFILES"
    rm -rf $DEBUGTMPDIR/public
    rm -rf $DEBUGTMPDIR/modbus2mqtt/specifications
    rm -rf $DEBUGTMPDIR/modbus2mqtt/busses
    # Ensure MQTT config exists in debug tmpdir
    if ! grep -q "^mqttconnect:" "$DEBUGTMPDIR/modbus2mqtt/modbus2mqtt.yaml"; then
      cat >>"$DEBUGTMPDIR/modbus2mqtt/modbus2mqtt.yaml" <<EOF
mqttconnect:
  mqttserverurl: mqtt://$localhost:3001
  username: homeassistant
  password: homeassistant
EOF
    fi
    sleep infinity &
    MPID=$!
else
  mkdir -p "$TMPDIR/modbus2mqtt"
  if [ -f "$TMPFILES" ]; then
      grep -v "^$HTTPPORT " "$TMPFILES" >"$TMPFILES.tmp" || true
      mv "$TMPFILES.tmp" "$TMPFILES"
  fi
  echo "$HTTPPORT $TMPDIR" >>"$TMPFILES"
  echo 'httpport: '"$HTTPPORT" >"$TMPDIR/modbus2mqtt/modbus2mqtt.yaml"
  logdir=cypress/servers/logs
  mkdir -p "$logdir"
  logfile="$logdir/modbus2mqtt_$HTTPPORT.out"
  # Create/refresh stable symlink pointing to current log
  ln -sf "$logfile" "$logdir/modbus2mqtt_${HTTPPORT}.log"
  for arg in "$@"; do
    echo  "arg: $arg" >>"$logfile"
  done
  # Ingress scenario indicated by second argument 'ingress'
  if [ "$2" = "ingress" ]
  then # port 3004 ingress
    echo "supervisor_host: '$localhost:3006'" >>"$TMPDIR/modbus2mqtt/modbus2mqtt.yaml"
    echo "ingress scenario" >>"$logfile"
 
    export HASSIO_TOKEN=abcd1234
  else
    echo "normal scenario" >>"$logfile"
    # Provide local MQTT connection details only for non-Hassio scenario
    cat >>"$TMPDIR/modbus2mqtt/modbus2mqtt.yaml" <<EOF
mqttconnect:
  mqttserverurl: mqtt://$localhost:3001
  username: homeassistant
  password: homeassistant
EOF
  fi
  # Use local workspace binary instead of distprod package
  node bin/modbus2mqtt -c "$TMPDIR"  -d "$TMPDIR" -s "$TMPDIR" >>"$logfile" 2>&1 &
  MPID=$!
fi
wait $MPID